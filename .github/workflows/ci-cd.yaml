---
name: Watchy Open Source CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

# Global permissions for the workflow
permissions:
  contents: read
  security-events: write
  actions: read

env:
  AWS_REGION: us-east-1

jobs:
  # ===== DETECT CHANGES =====
  detect-changes:
    name: Detect What Changed
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.changes.outputs.templates }}
      lambda: ${{ steps.changes.outputs.lambda }}
      workflows: ${{ steps.changes.outputs.workflows }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            templates:
              - 'cloudformation/**'
            lambda:
              - 'lambda/**'
            workflows:
              - '.github/workflows/**'

  # ===== VALIDATION (Always Run) =====
  validate:
    name: Validate Templates & Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install validation tools
        run: |
          pip install cfn-lint yamllint

      - name: Validate CloudFormation templates
        run: |
          echo "üîç Validating CloudFormation templates..."
          find . -name "*.yaml" -path "*/cloudformation/*" | \
            xargs cfn-lint

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."
          # Only validate CloudFormation templates and issue templates
          # Skip GitHub Actions workflows as they have different standards
          find . -name "*.yaml" -path "*/cloudformation/*" \
            -o -name "*.yaml" -path "*/.github/ISSUE_TEMPLATE/*" | \
            xargs yamllint -d relaxed

      - name: Validate Lambda code
        run: |
          echo "üîç Validating Lambda Python code..."
          find lambda -name "*.py" | while read file; do
            echo "Checking $file..."
            python -m py_compile "$file"
          done
          echo "‚úÖ All Lambda Python files are syntactically valid"

      - name: Test CloudFormation template syntax
        run: |
          echo "üîç Testing CloudFormation template syntax with AWS CLI..."
          # Test main templates
          aws cloudformation validate-template \
            --template-body file://cloudformation/watchy-monitoring-slack.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
          aws cloudformation validate-template \
            --template-body file://cloudformation/watchy-platform.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true

  # ===== SECURITY STAGE =====
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for potential secrets
        run: |
          echo "üîç Scanning for potential secrets..."

          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password.*[:=].*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*[:=].*['\"][^'\"]{16,}['\"]"
            "secret.*[:=].*['\"][^'\"]{12,}['\"]"
            "token.*[:=].*['\"][^'\"]{16,}['\"]"
            "aws[_-]?access[_-]?key.*[:=].*['\"][A-Z0-9]{20}['\"]"
            "aws[_-]?secret.*[:=].*['\"][A-Za-z0-9/+=]{40}['\"]"
          )

          FOUND_SECRETS=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" \
               --include="*.py" --include="*.yaml" \
               --include="*.yml" --include="*.json" \
               --exclude-dir=".git" . | \
               grep -v "# nosec" | grep -v "TEMPLATE" | \
               grep -v "example"; then
              FOUND_SECRETS=true
            fi
          done

          if [ "$FOUND_SECRETS" = true ]; then
            echo "‚ö†Ô∏è  Potential secrets detected"
            echo "Please review and add '# nosec' for false positives"
            echo "Consider using GitHub secrets or environment variables"
          else
            echo "‚úÖ No obvious secrets detected"
          fi

      - name: CloudFormation Security Check
        run: |
          echo "üîí Checking CloudFormation templates for security issues..."

          find cloudformation -name "*.yaml" -o -name "*.yml" | \
          while read template; do
            echo "üìã Checking: $template"

            # Check for hardcoded values
            if grep -i -E "(password|secret|key).*:" "$template" | \
               grep -v -E "(Ref|GetAtt|Parameter|!)" | head -3; then
              echo "‚ö†Ô∏è  Potential hardcoded sensitive values in $template"
            fi

            # Check for overly permissive IAM policies
            if grep -A 5 -B 5 "Effect.*Allow" "$template" | \
               grep -E '"\*"|\*' | head -3; then
              echo "‚ö†Ô∏è  Potential overly permissive IAM policy in $template"
            fi

            # Check for public S3 access
            if grep -i "PublicRead\|PublicReadWrite" "$template"; then
              echo "‚ö†Ô∏è  Public S3 access found in $template"
            fi

            echo "---"
          done
        continue-on-error: true

  # ===== BUILD LAMBDA FUNCTIONS =====
  build-lambda:
    name: Build Lambda Functions
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.lambda == 'true' || github.event_name == 'workflow_dispatch')
    
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required to checkout code
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Build Slack Monitor Lambda
      run: |
        cd lambda/slack_monitor
        
        # Set build metadata
        export BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        export LAMBDA_VERSION="1.0.0-${GITHUB_SHA:0:7}"
        
        echo "Building Slack Monitor Lambda..."
        echo "Version: $LAMBDA_VERSION"
        echo "Build Date: $BUILD_DATE"
        
        # Create build directory
        mkdir -p build
        
        # Copy Lambda function
        cp lambda_function.py build/
        
        # Install dependencies if requirements.txt has actual dependencies
        if grep -v '^#' requirements.txt | grep -v '^$' > /dev/null 2>&1; then
          echo "Installing Python dependencies..."
          pip install -r requirements.txt -t build/
        else
          echo "No external dependencies to install"
        fi
        
        # Create deployment package
        cd build
        zip -r ../slack-monitor.zip .
        cd ..
        
        # Verify zip contents
        echo "Lambda package contents:"
        unzip -l slack-monitor.zip
        
        # Get package size
        PACKAGE_SIZE=$(stat -c%s slack-monitor.zip)
        echo "Package size: $PACKAGE_SIZE bytes"
        
        if [ $PACKAGE_SIZE -gt 52428800 ]; then  # 50MB limit
          echo "ERROR: Package size exceeds Lambda limit of 50MB"
          exit 1
        fi
    
    - name: Upload Lambda packages to S3
      run: |
        cd lambda/slack_monitor
        
        # Upload with versioning
        aws s3 cp slack-monitor.zip s3://watchy-resources/lambda/slack-monitor.zip
        aws s3 cp slack-monitor.zip s3://watchy-resources/lambda/versions/slack-monitor-${GITHUB_SHA:0:7}.zip
        
        echo "Lambda package uploaded to S3:"
        echo "  Main: s3://watchy-resources/lambda/slack-monitor.zip"
        echo "  Versioned: s3://watchy-resources/lambda/versions/slack-monitor-${GITHUB_SHA:0:7}.zip"

  # ===== DEPLOY TEMPLATES TO S3 =====
  # ===== COORDINATE DEPLOYMENT =====
  coordinate-deployment:
    name: Coordinate Deployment
    runs-on: ubuntu-latest
    needs: [detect-changes, validate, build-lambda]
    if: |
      always() &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.templates == 'true' || needs.detect-changes.outputs.lambda == 'true' || github.event_name == 'workflow_dispatch') &&
      needs.validate.result == 'success' &&
      (needs.build-lambda.result == 'success' || needs.build-lambda.result == 'skipped')
    
    outputs:
      ready-to-deploy: ${{ steps.check.outputs.ready }}
    
    steps:
      - name: Check deployment readiness
        id: check
        run: |
          echo "All prerequisites met for deployment"
          echo "ready=true" >> $GITHUB_OUTPUT

  # ===== DEPLOY TEMPLATES TO S3 =====
  deploy-templates:
    name: Deploy Templates to S3
    runs-on: ubuntu-latest
    needs: [coordinate-deployment]
    if: needs.coordinate-deployment.outputs.ready-to-deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation templates to S3
        run: |
          echo "üì§ Deploying CloudFormation templates to S3..."

          # Set version for this deployment
          VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}

          # Deploy to production bucket
          TEMPLATE_BUCKET="watchy-resources"

          echo "‚úÖ Deploying templates to bucket: $TEMPLATE_BUCKET"

          # Deploy templates to S3 (now from cloudformation/ directory)
          aws s3 sync cloudformation/ \
            s3://${TEMPLATE_BUCKET}/cloudformation/ \
            --delete \
            --cache-control "max-age=3600" \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Templates deployed successfully"

          # Invalidate CloudFront cache if distribution exists
          echo "üîç Looking for CloudFront distribution..."
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${TEMPLATE_BUCKET}.s3.amazonaws.com\`].Id | [0]" \
            --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && \
             [ "$DISTRIBUTION_ID" != "null" ]; then
            echo "üîÑ Invalidating CloudFront cache for templates..."
            aws cloudfront create-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --paths "/*" \
              --region ${{ env.AWS_REGION }} \
              --output text >/dev/null 2>&1 || \
              echo "‚ö†Ô∏è  Cache invalidation failed (non-critical)"
            echo "‚úÖ CloudFront cache invalidated"
          else
            echo "‚ÑπÔ∏è  No CloudFront distribution found, skipping cache invalidation"
          fi

  # ===== TEST DEPLOYMENT =====
  test-deployment:
    name: Test Template Accessibility
    runs-on: ubuntu-latest
    needs: [deploy-templates]
    if: needs.deploy-templates.result == 'success'

    steps:
      - name: Test template URLs
        run: |
          echo "üß™ Testing template accessibility..."

          # Test platform template (parent stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-platform.yaml" > /dev/null; then
            echo "‚úÖ Platform template (parent stack) is accessible"
          else
            echo "‚ùå Platform template (parent stack) is not accessible"
            exit 1
          fi

          # Test Slack monitoring template (nested stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-monitoring-slack.yaml" > /dev/null; then
            echo "‚úÖ Slack monitoring template (nested stack) is accessible"
          else
            echo "‚ùå Slack monitoring template (nested stack) is not accessible"
            exit 1
          fi

          # Test Lambda package
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/lambda/slack-monitor.zip" > /dev/null; then
            echo "‚úÖ Slack Lambda package is accessible"
          else
            echo "‚ùå Slack Lambda package is not accessible"
            exit 1
          fi

          echo "‚úÖ Template accessibility test completed"

      - name: Validate deployed templates
        run: |
          echo "üîç Validating deployed templates..."

          # Download and validate the deployed platform template (parent stack)
          curl -s "https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-platform.yaml" > deployed-platform-template.yaml

          # Download and validate the deployed Slack template (nested stack)
          curl -s "https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-monitoring-slack.yaml" > deployed-slack-template.yaml

          # Validate platform template
          if grep -q "AWSTemplateFormatVersion" deployed-platform-template.yaml; then
            echo "‚úÖ Platform template has valid CloudFormation format"
          else
            echo "‚ùå Platform template is missing CloudFormation format version"
            exit 1
          fi

          if grep -q "AWS::CloudFormation::Stack" deployed-platform-template.yaml; then
            echo "‚úÖ Platform template contains nested stack resources"
          else
            echo "‚ùå Platform template is missing nested stack configuration"
            exit 1
          fi

          # Validate Slack template
          if grep -q "AWSTemplateFormatVersion" deployed-slack-template.yaml; then
            echo "‚úÖ Slack template has valid CloudFormation format"
          else
            echo "‚ùå Slack template is missing CloudFormation format version"
            exit 1
          fi

          if grep -q "lambda_function.lambda_handler" deployed-slack-template.yaml; then
            echo "‚úÖ Slack template references external Lambda package"
          else
            echo "‚ùå Slack template is missing Lambda function reference"
            exit 1
          fi

          echo "‚úÖ Nested stack template validation completed"

  # ===== NOTIFICATION =====
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [test-deployment, detect-changes, validate, security-scan, build-lambda, coordinate-deployment]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Deployment Summary
        run: |
          echo "## üöÄ Watchy Open Source Deployment Summary"
          echo "### Changes Detected:"
          echo "- Templates: ${{ needs.detect-changes.outputs.templates }}"
          echo "- Lambda: ${{ needs.detect-changes.outputs.lambda }}"
          echo "- Workflows: ${{ needs.detect-changes.outputs.workflows }}"

          echo ""
          echo "### Job Results:"
          echo "- Validation: ${{ needs.validate.result }}"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Lambda Build: ${{ needs.build-lambda.result }}"
          echo "- Deployment Coordination: ${{ needs.coordinate-deployment.result }}"
          echo "- Template Deployment: ${{ needs.deploy-templates.result }}"
          echo "- Testing: ${{ needs.test-deployment.result }}"

          if [ "${{ needs.test-deployment.result }}" = "success" ]; then
            echo ""
            echo "### ‚úÖ Deployment Successful!"
            echo "üîó Platform Template: https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-platform.yaml"
            echo "üîó Slack Template: https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-monitoring-slack.yaml"
            echo "üì¶ Lambda Package: https://s3.amazonaws.com/watchy-resources/lambda/slack-monitor.zip"
            echo "üìö Documentation: Updated in repository"
            echo ""
            echo "### üöÄ Quick Deploy Command:"
            echo '```bash'
            echo 'aws cloudformation deploy \'
            echo '  --template-url https://s3.amazonaws.com/watchy-resources/cloudformation/watchy-platform.yaml \'
            echo '  --stack-name Watchy-Platform \'
            echo '  --capabilities CAPABILITY_NAMED_IAM \'
            echo '  --parameter-overrides \'
            echo '    NotificationEmail=your-email@domain.com \'
            echo '    MonitoringSchedule="rate(5 minutes)" \'
            echo '    EnableSlackMonitoring=true'
            echo '```'
          else
            echo ""
            echo "### ‚ùå Deployment Issues"
            echo "Check the workflow logs for details"
          fi

          echo ""
          echo "## üèóÔ∏è Architecture Benefits"
          echo "- ‚úÖ Separated Lambda source code for better maintainability"
          echo "- ‚úÖ Automated Lambda building and deployment"
          echo "- ‚úÖ Version-controlled Lambda functions"
          echo "- ‚úÖ CI/CD pipeline for both templates and code"
          echo "- ‚úÖ Pure Python implementation - no binaries"
          echo "- ‚úÖ All monitoring logic visible and auditable"
          echo "- ‚úÖ Shared resources reduce costs and complexity"
          echo "- ‚úÖ Easy to add new SaaS monitoring services"
          echo "- ‚úÖ Community-friendly development"

          echo ""
          echo "## üîí Security Summary"
          echo "### Enabled Features:"
          echo "- ‚úÖ Secret pattern detection"
          echo "- ‚úÖ CloudFormation security checks"
          echo "- ‚úÖ Template validation"
          echo "- ‚úÖ YAML syntax validation"
          echo "- ‚úÖ Dependabot dependency updates"
