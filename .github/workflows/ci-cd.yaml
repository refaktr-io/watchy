---
name: Watchy Open Source CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

# Global permissions for the workflow
permissions:
  contents: read
  security-events: write
  actions: read

env:
  AWS_REGION: us-east-1

jobs:
  # ===== DETECT CHANGES =====
  detect-changes:
    name: Detect What Changed
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.changes.outputs.templates }}
      lambda: ${{ steps.changes.outputs.lambda }}
      workflows: ${{ steps.changes.outputs.workflows }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            templates:
              - 'cloudformation/**'
            lambda:
              - 'lambda/**'
            workflows:
              - '.github/workflows/**'

      - name: Debug change detection
        run: |
          echo "Templates changed: ${{ steps.changes.outputs.templates }}"
          echo "Lambda changed: ${{ steps.changes.outputs.lambda }}"
          echo "Workflows changed: ${{ steps.changes.outputs.workflows }}"

  # ===== VALIDATION (Always Run) =====
  validate:
    name: Validate Templates & Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install validation tools
        run: |
          pip install cfn-lint yamllint

      - name: Validate CloudFormation templates
        run: |
          echo "ðŸ” Validating CloudFormation templates..."
          find . -name "*.yaml" -path "*/cloudformation/*" | \
            xargs cfn-lint

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validating YAML syntax..."
          # Only validate CloudFormation templates and issue templates
          # Skip GitHub Actions workflows as they have different standards
          find . -name "*.yaml" -path "*/cloudformation/*" \
            -o -name "*.yaml" -path "*/.github/ISSUE_TEMPLATE/*" | \
            xargs yamllint -d relaxed

      - name: Validate Lambda code
        run: |
          echo "ðŸ” Validating Lambda Python code..."
          find lambda -name "*.py" | while read file; do
            echo "Checking $file..."
            python -m py_compile "$file"
          done
          echo "âœ… All Lambda Python files are syntactically valid"

      - name: Test CloudFormation template syntax
        run: |
          echo "ðŸ” Testing CloudFormation template syntax with AWS CLI..."
          # Test main templates
          aws cloudformation validate-template \
            --template-body file://cloudformation/watchy-monitoring-slack.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
          aws cloudformation validate-template \
            --template-body file://cloudformation/watchy-platform.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true

  # ===== SECURITY STAGE =====
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for potential secrets
        run: |
          echo "ðŸ” Scanning for potential secrets..."

          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password.*[:=].*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*[:=].*['\"][^'\"]{16,}['\"]"
            "secret.*[:=].*['\"][^'\"]{12,}['\"]"
            "token.*[:=].*['\"][^'\"]{16,}['\"]"
            "aws[_-]?access[_-]?key.*[:=].*['\"][A-Z0-9]{20}['\"]"
            "aws[_-]?secret.*[:=].*['\"][A-Za-z0-9/+=]{40}['\"]"
          )

          FOUND_SECRETS=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" \
               --include="*.py" --include="*.yaml" \
               --include="*.yml" --include="*.json" \
               --exclude-dir=".git" . | \
               grep -v "# nosec" | grep -v "TEMPLATE" | \
               grep -v "example"; then
              FOUND_SECRETS=true
            fi
          done

          if [ "$FOUND_SECRETS" = true ]; then
            echo "âš ï¸  Potential secrets detected"
            echo "Please review and add '# nosec' for false positives"
            echo "Consider using GitHub secrets or environment variables"
          else
            echo "âœ… No obvious secrets detected"
          fi

      - name: CloudFormation Security Check
        run: |
          echo "ðŸ”’ Checking CloudFormation templates for security issues..."

          find cloudformation -name "*.yaml" -o -name "*.yml" | \
          while read template; do
            echo "ðŸ“‹ Checking: $template"

            # Check for hardcoded values
            if grep -i -E "(password|secret|key).*:" "$template" | \
               grep -v -E "(Ref|GetAtt|Parameter|!)" | head -3; then
              echo "âš ï¸  Potential hardcoded sensitive values in $template"
            fi

            # Check for overly permissive IAM policies
            if grep -A 5 -B 5 "Effect.*Allow" "$template" | \
               grep -E '"\*"|\*' | head -3; then
              echo "âš ï¸  Potential overly permissive IAM policy in $template"
            fi

            # Check for public S3 access
            if grep -i "PublicRead\|PublicReadWrite" "$template"; then
              echo "âš ï¸  Public S3 access found in $template"
            fi

            echo "---"
          done
        continue-on-error: true

  # ===== BUILD LAMBDA FUNCTIONS =====
  build-lambda:
    name: Build Lambda Functions
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    # Run when: manual dispatch, OR on main branch when anything changes that requires deployment
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.ref == 'refs/heads/main' && 
       (needs.detect-changes.outputs.lambda == 'true' || 
        needs.detect-changes.outputs.templates == 'true'))
    
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required to checkout code
    
    steps:
    - name: Debug job execution
      run: |
        echo "Build Lambda job is running because:"
        echo "- Branch: ${{ github.ref }}"
        echo "- Event: ${{ github.event_name }}"
        echo "- Lambda changed: ${{ needs.detect-changes.outputs.lambda }}"
        echo "- Templates changed: ${{ needs.detect-changes.outputs.templates }}"
        
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Build Slack Monitor Lambda
      run: |
        cd lambda/slack_monitor
        
        # Set build metadata
        export LAMBDA_VERSION="1.0.0-${GITHUB_SHA:0:7}"
        
        echo "Building Slack Monitor Lambda..."
        echo "Version: $LAMBDA_VERSION"
        
        # Create build directory
        mkdir -p build
        
        # Copy Lambda function
        cp lambda_function.py build/
        
        # No external dependencies needed - uses only Python standard library and boto3 (AWS provided)
        
        # Create deployment package
        cd build
        zip -r ../slack-monitor.zip .
        cd ..
        
        # Verify zip contents
        echo "Lambda package contents:"
        unzip -l slack-monitor.zip
        
        # Get package size
        PACKAGE_SIZE=$(stat -c%s slack-monitor.zip)
        echo "Package size: $PACKAGE_SIZE bytes"
        
        if [ $PACKAGE_SIZE -gt 52428800 ]; then  # 50MB limit
          echo "ERROR: Package size exceeds Lambda limit of 50MB"
          exit 1
        fi
    
    - name: Upload Lambda packages to S3
      run: |
        cd lambda/slack_monitor
        
        # Debug: Show current directory and files
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        
        # Check if zip file exists
        if [ ! -f "slack-monitor.zip" ]; then
          echo "ERROR: slack-monitor.zip not found!"
          exit 1
        fi
        
        # Upload to S3
        echo "Uploading to S3..."
        aws s3 cp slack-monitor.zip s3://watchy-resources/slack-monitor.zip
        
        echo "Lambda package uploaded to S3:"
        echo "  Main: s3://watchy-resources/slack-monitor.zip"
        
        # Debug: Verify upload
        echo "Verifying S3 upload:"
        aws s3 ls s3://watchy-resources/slack-monitor.zip

  # ===== DEPLOY TEMPLATES TO S3 =====
  deploy-templates:
    name: Deploy Templates to S3
    runs-on: ubuntu-latest
    needs: [detect-changes, validate, build-lambda]
    if: |
      always() &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.templates == 'true' || needs.detect-changes.outputs.lambda == 'true' || github.event_name == 'workflow_dispatch') &&
      needs.validate.result == 'success' &&
      (needs.build-lambda.result == 'success' || needs.build-lambda.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation templates to S3
        run: |
          echo "ðŸ“¤ Deploying CloudFormation templates to S3..."

          # Set version for this deployment
          VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}

          # Deploy to production bucket
          TEMPLATE_BUCKET="watchy-resources"

          echo "âœ… Deploying templates to bucket: $TEMPLATE_BUCKET"
          
          # Debug: Check if bucket exists and is accessible
          echo "Testing bucket access..."
          aws s3 ls s3://${TEMPLATE_BUCKET}/ --region ${{ env.AWS_REGION }} || echo "Bucket access failed"
          
          # Debug: Show what files we're about to deploy
          echo "Files in cloudformation/ directory:"
          ls -la cloudformation/

          # Deploy templates to S3 (to root of bucket)
          aws s3 sync cloudformation/ \
            s3://${TEMPLATE_BUCKET}/ \
            --cache-control "max-age=3600" \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Templates deployed successfully"
          
          # Debug: Verify what was uploaded
          echo "Files now in S3 bucket:"
          aws s3 ls s3://${TEMPLATE_BUCKET}/ --region ${{ env.AWS_REGION }}

          # Invalidate CloudFront cache if distribution exists
          echo "ðŸ” Looking for CloudFront distribution..."
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${TEMPLATE_BUCKET}.s3.amazonaws.com\`].Id | [0]" \
            --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && \
             [ "$DISTRIBUTION_ID" != "null" ]; then
            echo "ðŸ”„ Invalidating CloudFront cache for templates..."
            aws cloudfront create-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --paths "/*" \
              --region ${{ env.AWS_REGION }} \
              --output text >/dev/null 2>&1 || \
              echo "âš ï¸  Cache invalidation failed (non-critical)"
            echo "âœ… CloudFront cache invalidated"
          else
            echo "â„¹ï¸  No CloudFront distribution found, skipping cache invalidation"
          fi

  # ===== TEST DEPLOYMENT =====
  test-deployment:
    name: Test Template Accessibility
    runs-on: ubuntu-latest
    needs: [deploy-templates]
    if: needs.deploy-templates.result == 'success'

    steps:
      - name: Test template URLs
        run: |
          echo "ðŸ§ª Testing template accessibility..."

          # Test platform template (parent stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/watchy-platform.yaml" > /dev/null; then
            echo "âœ… Platform template (parent stack) is accessible"
          else
            echo "âŒ Platform template (parent stack) is not accessible"
            exit 1
          fi

          # Test Slack monitoring template (nested stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/watchy-monitoring-slack.yaml" > /dev/null; then
            echo "âœ… Slack monitoring template (nested stack) is accessible"
          else
            echo "âŒ Slack monitoring template (nested stack) is not accessible"
            exit 1
          fi

          # Test Lambda package
          if curl -f -s "https://s3.amazonaws.com/watchy-resources/slack-monitor.zip" > /dev/null; then
            echo "âœ… Slack Lambda package is accessible"
          else
            echo "âŒ Slack Lambda package is not accessible"
            exit 1
          fi

          echo "âœ… Template accessibility test completed"

      - name: Validate deployed templates
        run: |
          echo "ðŸ” Validating deployed templates..."

          # Download and validate the deployed platform template (parent stack)
          curl -s "https://s3.amazonaws.com/watchy-resources/watchy-platform.yaml" > deployed-platform-template.yaml

          # Download and validate the deployed Slack template (nested stack)
          curl -s "https://s3.amazonaws.com/watchy-resources/watchy-monitoring-slack.yaml" > deployed-slack-template.yaml

          # Debug: Show what we downloaded
          echo "Platform template size: $(wc -c < deployed-platform-template.yaml) bytes"
          echo "Slack template size: $(wc -c < deployed-slack-template.yaml) bytes"

          # Validate platform template
          if grep -q "AWSTemplateFormatVersion" deployed-platform-template.yaml; then
            echo "âœ… Platform template has valid CloudFormation format"
          else
            echo "âŒ Platform template is missing CloudFormation format version"
            echo "First 10 lines of platform template:"
            head -10 deployed-platform-template.yaml
            exit 1
          fi

          if grep -q "AWS::CloudFormation::Stack" deployed-platform-template.yaml; then
            echo "âœ… Platform template contains nested stack resources"
          else
            echo "âŒ Platform template is missing nested stack configuration"
            echo "Searching for stack references:"
            grep -i "stack" deployed-platform-template.yaml | head -5 || echo "No stack references found"
            exit 1
          fi

          # Validate Slack template
          if grep -q "AWSTemplateFormatVersion" deployed-slack-template.yaml; then
            echo "âœ… Slack template has valid CloudFormation format"
          else
            echo "âŒ Slack template is missing CloudFormation format version"
            echo "First 10 lines of Slack template:"
            head -10 deployed-slack-template.yaml
            exit 1
          fi

          # Check for Lambda handler reference (more flexible pattern)
          if grep -q "Handler.*lambda_function.lambda_handler" deployed-slack-template.yaml; then
            echo "âœ… Slack template references external Lambda package"
          else
            echo "âŒ Slack template is missing Lambda function reference"
            echo "Searching for Lambda handler references:"
            grep -i "handler\|lambda_function" deployed-slack-template.yaml | head -5 || echo "No handler references found"
            exit 1
          fi

          # Additional validation: Check for S3 code reference
          if grep -q "S3Bucket.*watchy-resources" deployed-slack-template.yaml; then
            echo "âœ… Slack template references S3 Lambda package"
          else
            echo "âš ï¸  Slack template may not reference S3 Lambda package correctly"
            echo "Searching for S3 references:"
            grep -i "s3" deployed-slack-template.yaml | head -3 || echo "No S3 references found"
          fi

          echo "âœ… Template validation completed successfully"

  # ===== NOTIFICATION =====
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [test-deployment, detect-changes, validate, security-scan, build-lambda]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Watchy Open Source Deployment Summary"
          echo "### Changes Detected:"
          echo "- Templates: ${{ needs.detect-changes.outputs.templates }}"
          echo "- Lambda: ${{ needs.detect-changes.outputs.lambda }}"
          echo "- Workflows: ${{ needs.detect-changes.outputs.workflows }}"

          echo ""
          echo "### Job Results:"
          echo "- Validation: ${{ needs.validate.result }}"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Lambda Build: ${{ needs.build-lambda.result }}"
          echo "- Deployment Coordination: ${{ needs.coordinate-deployment.result }}"
          echo "- Template Deployment: ${{ needs.deploy-templates.result }}"
          echo "- Testing: ${{ needs.test-deployment.result }}"

          if [ "${{ needs.test-deployment.result }}" = "success" ]; then
            echo ""
            echo "### âœ… Deployment Successful!"
            echo "ðŸ”— Platform Template: https://s3.amazonaws.com/watchy-resources/watchy-platform.yaml"
            echo "ðŸ”— Slack Template: https://s3.amazonaws.com/watchy-resources/watchy-monitoring-slack.yaml"
            echo "ðŸ“¦ Lambda Package: https://s3.amazonaws.com/watchy-resources/slack-monitor.zip"
            echo "ðŸ“š Documentation: Updated in repository"
            echo ""
            echo "### ðŸš€ Quick Deploy Command:"
            echo '```bash'
            echo 'aws cloudformation deploy \'
            echo '  --template-url https://s3.amazonaws.com/watchy-resources/watchy-platform.yaml \'
            echo '  --stack-name Watchy-Platform \'
            echo '  --capabilities CAPABILITY_NAMED_IAM \'
            echo '  --parameter-overrides \'
            echo '    NotificationEmail=your-email@domain.com \'
            echo '    MonitoringSchedule="rate(5 minutes)" \'
            echo '    EnableSlackMonitoring=true'
            echo '```'
          else
            echo ""
            echo "### âŒ Deployment Issues"
            echo "Check the workflow logs for details"
          fi

          echo ""
          echo "## ðŸ—ï¸ Architecture Benefits"
          echo "- âœ… Separated Lambda source code for better maintainability"
          echo "- âœ… Automated Lambda building and deployment"
          echo "- âœ… Version-controlled Lambda functions"
          echo "- âœ… CI/CD pipeline for both templates and code"
          echo "- âœ… Pure Python implementation - no binaries"
          echo "- âœ… All monitoring logic visible and auditable"
          echo "- âœ… Shared resources reduce costs and complexity"
          echo "- âœ… Easy to add new SaaS monitoring services"
          echo "- âœ… Community-friendly development"

          echo ""
          echo "## ðŸ”’ Security Summary"
          echo "### Enabled Features:"
          echo "- âœ… Secret pattern detection"
          echo "- âœ… CloudFormation security checks"
          echo "- âœ… Template validation"
          echo "- âœ… YAML syntax validation"
          echo "- âœ… Dependabot dependency updates"
