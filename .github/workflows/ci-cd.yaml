---
name: Watchy Open Source CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

# Global permissions for the workflow
permissions:
  contents: read
  security-events: write
  actions: read

env:
  AWS_REGION: us-east-1

jobs:
  # ===== DETECT CHANGES =====
  detect-changes:
    name: Detect What Changed
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.changes.outputs.templates }}
      workflows: ${{ steps.changes.outputs.workflows }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            templates:
              - 'templates/**'
            workflows:
              - '.github/workflows/**'

  # ===== VALIDATION (Always Run) =====
  validate:
    name: Validate Templates & Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install validation tools
        run: |
          pip install cfn-lint yamllint

      - name: Validate CloudFormation templates
        run: |
          echo "üîç Validating CloudFormation templates..."
          find . -name "*.yaml" -path "*/templates/*" | \
            xargs cfn-lint

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."
          # Only validate CloudFormation templates and issue templates
          # Skip GitHub Actions workflows as they have different standards
          find . -name "*.yaml" -path "*/templates/*" \
            -o -name "*.yaml" -path "*/.github/ISSUE_TEMPLATE/*" | \
            xargs yamllint -d relaxed

      - name: Test CloudFormation template syntax
        run: |
          echo "üîç Testing CloudFormation template syntax with AWS CLI..."
          # Test main templates
          aws cloudformation validate-template \
            --template-body file://templates/watchy-monitoring-slack.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
          aws cloudformation validate-template \
            --template-body file://templates/watchy-platform.yaml \
            --region ${{ env.AWS_REGION }} --no-cli-pager
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true

  # ===== SECURITY STAGE =====
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for potential secrets
        run: |
          echo "üîç Scanning for potential secrets..."

          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password.*[:=].*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*[:=].*['\"][^'\"]{16,}['\"]"
            "secret.*[:=].*['\"][^'\"]{12,}['\"]"
            "token.*[:=].*['\"][^'\"]{16,}['\"]"
            "aws[_-]?access[_-]?key.*[:=].*['\"][A-Z0-9]{20}['\"]"
            "aws[_-]?secret.*[:=].*['\"][A-Za-z0-9/+=]{40}['\"]"
          )

          FOUND_SECRETS=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" \
               --include="*.py" --include="*.yaml" \
               --include="*.yml" --include="*.json" \
               --exclude-dir=".git" . | \
               grep -v "# nosec" | grep -v "TEMPLATE" | \
               grep -v "example"; then
              FOUND_SECRETS=true
            fi
          done

          if [ "$FOUND_SECRETS" = true ]; then
            echo "‚ö†Ô∏è  Potential secrets detected"
            echo "Please review and add '# nosec' for false positives"
            echo "Consider using GitHub secrets or environment variables"
          else
            echo "‚úÖ No obvious secrets detected"
          fi

      - name: CloudFormation Security Check
        run: |
          echo "üîí Checking CloudFormation templates for security issues..."

          find templates -name "*.yaml" -o -name "*.yml" | \
          while read template; do
            echo "üìã Checking: $template"

            # Check for hardcoded values
            if grep -i -E "(password|secret|key).*:" "$template" | \
               grep -v -E "(Ref|GetAtt|Parameter|!)" | head -3; then
              echo "‚ö†Ô∏è  Potential hardcoded sensitive values in $template"
            fi

            # Check for overly permissive IAM policies
            if grep -A 5 -B 5 "Effect.*Allow" "$template" | \
               grep -E '"\*"|\*' | head -3; then
              echo "‚ö†Ô∏è  Potential overly permissive IAM policy in $template"
            fi

            # Check for public S3 access
            if grep -i "PublicRead\|PublicReadWrite" "$template"; then
              echo "‚ö†Ô∏è  Public S3 access found in $template"
            fi

            echo "---"
          done
        continue-on-error: true

  # ===== DEPLOY TEMPLATES TO S3 =====
  deploy-templates:
    name: Deploy Templates to S3
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.templates == 'true' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation templates to S3
        run: |
          echo "üì§ Deploying CloudFormation templates to S3..."

          # Set version for this deployment
          VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}

          # Deploy to production bucket
          TEMPLATE_BUCKET="watchy-templates"

          echo "‚úÖ Deploying templates to bucket: $TEMPLATE_BUCKET"

          # Deploy templates to S3
          aws s3 sync templates/ \
            s3://${TEMPLATE_BUCKET}/ \
            --delete \
            --cache-control "max-age=3600" \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Templates deployed successfully"

          # Invalidate CloudFront cache if distribution exists
          echo "üîç Looking for CloudFront distribution..."
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${TEMPLATE_BUCKET}.s3.amazonaws.com\`].Id | [0]" \
            --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && \
             [ "$DISTRIBUTION_ID" != "null" ]; then
            echo "üîÑ Invalidating CloudFront cache for templates..."
            aws cloudfront create-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --paths "/*" \
              --region ${{ env.AWS_REGION }} \
              --output text >/dev/null 2>&1 || \
              echo "‚ö†Ô∏è  Cache invalidation failed (non-critical)"
            echo "‚úÖ CloudFront cache invalidated"
          else
            echo "‚ÑπÔ∏è  No CloudFront distribution found, skipping cache invalidation"
          fi

  # ===== TEST DEPLOYMENT =====
  test-deployment:
    name: Test Template Accessibility
    runs-on: ubuntu-latest
    needs: [deploy-templates]
    if: needs.deploy-templates.result == 'success'

    steps:
      - name: Test template URLs
        run: |
          echo "üß™ Testing template accessibility..."

          # Test platform template (parent stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-templates/watchy-platform.yaml" > /dev/null; then
            echo "‚úÖ Platform template (parent stack) is accessible"
          else
            echo "‚ùå Platform template (parent stack) is not accessible"
            exit 1
          fi

          # Test Slack monitoring template (nested stack)
          if curl -f -s "https://s3.amazonaws.com/watchy-templates/watchy-monitoring-slack.yaml" > /dev/null; then
            echo "‚úÖ Slack monitoring template (nested stack) is accessible"
          else
            echo "‚ùå Slack monitoring template (nested stack) is not accessible"
            exit 1
          fi

          echo "‚úÖ Template accessibility test completed"

      - name: Validate deployed templates
        run: |
          echo "üîç Validating deployed templates..."

          # Download and validate the deployed platform template (parent stack)
          curl -s "https://s3.amazonaws.com/watchy-templates/watchy-platform.yaml" > deployed-platform-template.yaml

          # Download and validate the deployed Slack template (nested stack)
          curl -s "https://s3.amazonaws.com/watchy-templates/watchy-monitoring-slack.yaml" > deployed-slack-template.yaml

          # Validate platform template
          if grep -q "AWSTemplateFormatVersion" deployed-platform-template.yaml; then
            echo "‚úÖ Platform template has valid CloudFormation format"
          else
            echo "‚ùå Platform template is missing CloudFormation format version"
            exit 1
          fi

          if grep -q "AWS::CloudFormation::Stack" deployed-platform-template.yaml; then
            echo "‚úÖ Platform template contains nested stack resources"
          else
            echo "‚ùå Platform template is missing nested stack configuration"
            exit 1
          fi

          # Validate Slack template
          if grep -q "AWSTemplateFormatVersion" deployed-slack-template.yaml; then
            echo "‚úÖ Slack template has valid CloudFormation format"
          else
            echo "‚ùå Slack template is missing CloudFormation format version"
            exit 1
          fi

          if grep -q "lambda_handler" deployed-slack-template.yaml; then
            echo "‚úÖ Slack template contains Lambda function code"
          else
            echo "‚ùå Slack template is missing Lambda function code"
            exit 1
          fi

          echo "‚úÖ Nested stack template validation completed"

  # ===== PUBLISH TO PUBLIC GITHUB =====
  publish-to-github:
    name: Publish to Public GitHub Repository
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: |
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.templates == 'true' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout public repository
        uses: actions/checkout@v4
        with:
          repository: your-org/watchy-core  # Update this to your public repo
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          path: public-repo
        continue-on-error: true

      - name: Copy files to public repository
        if: steps.checkout-public.outcome == 'success'
        run: |
          echo "üìã Copying files to public repository..."

          # Copy CloudFormation templates
          mkdir -p public-repo/templates
          cp templates/watchy-platform.yaml public-repo/templates/
          cp templates/watchy-monitoring-slack.yaml public-repo/templates/

          # Copy documentation
          cp README.md public-repo/

          echo "‚úÖ Files copied to public repository"

      - name: Commit and push to public repository
        if: steps.checkout-public.outcome == 'success'
        run: |
          cd public-repo

          # Configure git
          git config user.name "watchy-automation"
          git config user.email "automation@watchy.cloud"

          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to publish"
            exit 0
          fi

          # Stage changes
          git add .

          # Commit with version information
          VERSION=$(date -u +%Y.%m.%d.%H%M%S)
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          git commit -m "Update Watchy open source platform v${VERSION}

          - CloudFormation templates updated with pure Python implementation
          - Documentation updated for open source architecture
          - Source commit: ${GITHUB_SHA}

          Published from: https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"

          # Push to main branch
          git push origin main

          echo "‚úÖ Published to public repository"

  # ===== NOTIFICATION =====
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [test-deployment, detect-changes, validate, security-scan]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Deployment Summary
        run: |
          echo "## üöÄ Watchy Open Source Deployment Summary"
          echo "### Changes Detected:"
          echo "- Templates: ${{ needs.detect-changes.outputs.templates }}"
          echo "- Workflows: ${{ needs.detect-changes.outputs.workflows }}"

          echo ""
          echo "### Job Results:"
          echo "- Validation: ${{ needs.validate.result }}"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Template Deployment: ${{ needs.deploy-templates.result }}"
          echo "- Testing: ${{ needs.test-deployment.result }}"

          if [ "${{ needs.test-deployment.result }}" = "success" ]; then
            echo ""
            echo "### ‚úÖ Nested Stack Deployment Successful!"
            echo "üîó Platform Template (Parent): https://s3.amazonaws.com/watchy-templates/watchy-platform.yaml"
            echo "üîó Slack Template (Nested): https://s3.amazonaws.com/watchy-templates/watchy-monitoring-slack.yaml"
            echo "üìö Documentation: Updated in repository"
            echo ""
            echo "### üöÄ Quick Deploy Command (Nested Stack):"
            echo '```bash'
            echo 'aws cloudformation deploy \'
            echo '  --template-url https://s3.amazonaws.com/watchy-templates/watchy-platform.yaml \'
            echo '  --stack-name Watchy-Platform \'
            echo '  --capabilities CAPABILITY_NAMED_IAM \'
            echo '  --parameter-overrides \'
            echo '    NotificationEmail=your-email@domain.com \'
            echo '    MonitoringSchedule="rate(5 minutes)" \'
            echo '    EnableSlackMonitoring=true'
            echo '```'
          else
            echo ""
            echo "### ‚ùå Deployment Issues"
            echo "Check the workflow logs for details"
          fi

          echo ""
          echo "## üåü Nested Stack Architecture Benefits"
          echo "- ‚úÖ Pure Python implementation - no binaries"
          echo "- ‚úÖ All monitoring logic visible in CloudFormation"
          echo "- ‚úÖ Shared resources reduce costs and complexity"
          echo "- ‚úÖ Easy to add new SaaS monitoring services"
          echo "- ‚úÖ Centralized management and configuration"
          echo "- ‚úÖ Community-friendly development"
          echo "- ‚úÖ Faster cold starts and lower memory usage"
          echo "- ‚úÖ Community-friendly development"
          echo "- ‚úÖ Transparent security auditing"

          echo ""
          echo "## üîí Security Summary"
          echo "### Enabled Features:"
          echo "- ‚úÖ Secret pattern detection"
          echo "- ‚úÖ CloudFormation security checks"
          echo "- ‚úÖ Template validation"
          echo "- ‚úÖ YAML syntax validation"
          echo "- ‚úÖ Dependabot dependency updates"
