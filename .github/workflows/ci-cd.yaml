---
name: Optimized Watchy Platform CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      force_infrastructure:
        description: 'Force infrastructure redeployment'
        required: false
        default: false
        type: boolean

# Global permissions for the workflow
permissions:
  contents: read
  security-events: write
  actions: read

env:
  AWS_REGION: us-east-1

jobs:
  # ===== DETECT CHANGES =====
  detect-changes:
    name: Detect What Changed
    runs-on: ubuntu-latest
    outputs:
      infrastructure: ${{ steps.changes.outputs.infrastructure }}
      binaries: ${{ steps.changes.outputs.binaries }}
      platform: ${{ steps.changes.outputs.platform }}
      website: ${{ steps.changes.outputs.website }}
      force_infrastructure: ${{ github.event.inputs.force_infrastructure || 'false' }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          infrastructure:
            - 'platform/infrastructure/**'
          binaries:
            - 'platform/binaries/**'
          platform:
            - 'customer-templates/**'
            - 'platform/deploy/**'
            - 'platform/watchy-platform.yaml'
            - 'platform/README.md'
            - 'docs/**'
          website:
            - 'website/**'

  # ===== VALIDATION (Always Run) =====
  validate:
    name: Validate Code & Templates
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install validation tools
      run: |
        pip install cfn-lint flake8 black bandit safety

    - name: Validate CloudFormation templates
      run: |
        echo "üîç Validating CloudFormation templates..."
        find . -name "*.yaml" -path "*/platform/*" -o -name "*.yaml" -path "*/customer-templates/*" | xargs cfn-lint

    - name: Lint Python code
      run: |
        echo "üîç Linting Python code..."
        find . -name "*.py" -exec flake8 {} \;

    - name: Check Python code formatting
      run: |
        echo "üîç Checking Python formatting..."
        find . -name "*.py" -exec black --check {} \;

  # ===== SECURITY STAGE =====
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    # Only run on main branch to save resources
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    # Secret detection (simple but effective)
    - name: Check for potential secrets
      run: |
        echo "üîç Scanning for potential secrets..."

        # Check for common secret patterns
        SECRET_PATTERNS=(
          "password.*[:=].*['\"][^'\"]{8,}['\"]"
          "api[_-]?key.*[:=].*['\"][^'\"]{16,}['\"]"
          "secret.*[:=].*['\"][^'\"]{12,}['\"]"
          "token.*[:=].*['\"][^'\"]{16,}['\"]"
          "aws[_-]?access[_-]?key.*[:=].*['\"][A-Z0-9]{20}['\"]"
          "aws[_-]?secret.*[:=].*['\"][A-Za-z0-9/+=]{40}['\"]"
        )

        FOUND_SECRETS=false
        for pattern in "${SECRET_PATTERNS[@]}"; do
          if grep -r -i -E "$pattern" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.json" \
             --exclude-dir=".git" . | grep -v "# nosec" | grep -v "TEMPLATE" | grep -v "example"; then
            FOUND_SECRETS=true
          fi
        done

        if [ "$FOUND_SECRETS" = true ]; then
          echo "‚ö†Ô∏è  Potential secrets detected - please review and add '# nosec' for false positives"
          echo "Consider using GitHub secrets or environment variables instead"
        else
          echo "‚úÖ No obvious secrets detected"
        fi

    # Install security tools
    - name: Install security tools
      run: |
        pip install bandit safety

    # Python security analysis
    - name: Run Bandit (Python security)
      run: |
        echo "üîí Running Python security analysis..."

        if find platform/binaries -name "*.py" | head -1 > /dev/null; then
          bandit -r platform/binaries/ -f txt -o bandit-results.txt || true

          if [ -f bandit-results.txt ] && [ -s bandit-results.txt ]; then
            echo "üìã Bandit Results Summary:"
            grep -E "(High|Medium)" bandit-results.txt | head -10 || echo "No high/medium issues found"
          fi
        else
          echo "No Python files found for security analysis"
        fi
      continue-on-error: true

    # Dependency vulnerability check
    - name: Check dependencies for vulnerabilities
      run: |
        echo "üîí Checking dependencies for vulnerabilities..."

        EXIT_CODE=0
        find platform/binaries -name requirements.txt | while read req_file; do
          echo "üìã Checking: $req_file"

          if [ -s "$req_file" ]; then
            echo "Dependencies in $req_file:"
            cat "$req_file"
            echo "---"

            # Check for vulnerabilities
            if ! safety check -r "$req_file"; then
              echo "‚ö†Ô∏è  Vulnerabilities found in $req_file"
              echo "Run 'safety check -r $req_file' locally for details"
              EXIT_CODE=1
            else
              echo "‚úÖ No known vulnerabilities in $req_file"
            fi
          else
            echo "‚ö†Ô∏è  Empty requirements file: $req_file"
          fi
          echo ""
        done

        if [ $EXIT_CODE -ne 0 ]; then
          echo "‚ö†Ô∏è  Consider updating vulnerable dependencies"
        fi
      continue-on-error: true

    # CloudFormation security check
    - name: CloudFormation Security Check
      run: |
        echo "üîí Checking CloudFormation templates for security issues..."

        find platform customer-templates -name "*.yaml" -o -name "*.yml" | while read template; do
          echo "üìã Checking: $template"

          # Check for hardcoded values
          if grep -i -E "(password|secret|key).*:" "$template" | grep -v -E "(Ref|GetAtt|Parameter|!)" | head -3; then
            echo "‚ö†Ô∏è  Potential hardcoded sensitive values in $template"
          fi

          # Check for overly permissive IAM policies
          if grep -A 5 -B 5 "Effect.*Allow" "$template" | grep -E '"\*"|\*' | head -3; then
            echo "‚ö†Ô∏è  Potential overly permissive IAM policy in $template"
          fi

          # Check for public S3 access
          if grep -i "PublicRead\|PublicReadWrite" "$template"; then
            echo "‚ö†Ô∏è  Public S3 access found in $template"
          fi

          echo "---"
        done
      continue-on-error: true

    # Basic file permission check
    - name: File Permission Check
      run: |
        echo "üîí Checking file permissions..."

        # Check for files that might be too permissive
        if find . -type f -perm 777 2>/dev/null | head -5; then
          echo "‚ö†Ô∏è  Files with 777 permissions found"
        else
          echo "‚úÖ No overly permissive files found"
        fi

        # Check for executable files that shouldn't be
        if find . -name "*.py" -perm +111 -not -path "./.git/*" | head -5; then
          echo "‚ÑπÔ∏è  Executable Python files found (this may be intentional)"
        fi

  # ===== BUILD BINARIES (Only if Changed) =====
  build-binaries:
    name: Build Native Binaries
    runs-on: ubuntu-latest
    container:
      image: amazonlinux:2023
    needs: [detect-changes, validate]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.binaries == 'true' || needs.detect-changes.outputs.infrastructure == 'true' || needs.detect-changes.outputs.force_infrastructure == 'true')
    strategy:
      matrix:
        monitor: [slack-monitor]

    steps:
    - name: Install system dependencies
      run: |
        yum update -y
        yum install -y python3.13 python3.13-pip python3.13-devel gcc gcc-c++ make git tar gzip patchelf
        python3.13 -m pip install --upgrade pip

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python environment
      run: |
        python3.13 -m pip install nuitka wheel setuptools

    - name: Check if monitor changed
      id: monitor-changed
      run: |
        if [ "${{ needs.detect-changes.outputs.force_infrastructure }}" == "true" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üîÑ Force rebuild enabled for ${{ matrix.monitor }}"
        elif [ "${{ needs.detect-changes.outputs.binaries }}" == "true" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üìù Binary changes detected, building ${{ matrix.monitor }}"
        elif [ "${{ needs.detect-changes.outputs.infrastructure }}" == "true" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üèóÔ∏è Infrastructure changes detected, rebuilding ${{ matrix.monitor }}"
        else
          # Fallback: check if specific monitor files exist and have been modified recently
          if find platform/binaries/${{ matrix.monitor }}/ -name "*.py" -newer platform/binaries/${{ matrix.monitor }}/build.sh 2>/dev/null | grep -q .; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ÔøΩ Recent changes detected in ${{ matrix.monitor }} files"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üîÑ Building ${{ matrix.monitor }} (default behavior)"
          fi
        fi

    - name: Build ${{ matrix.monitor }}
      if: steps.monitor-changed.outputs.changed == 'true'
      run: |
        echo "üî® Building ${{ matrix.monitor }}..."
        cd platform/binaries/${{ matrix.monitor }}
        chmod +x build.sh

        # Set environment variables for build
        export WATCHY_VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}
        export PYTHON_VERSION=3.13

        # Build the binary
        ./build.sh

        # Verify binary was created
        if [ -f "lambda/watchy-${{ matrix.monitor }}" ]; then
          echo "‚úÖ Binary built successfully"
          ls -la lambda/
        else
          echo "‚ùå Binary build failed"
          exit 1
        fi

    - name: Upload binary artifacts
      if: steps.monitor-changed.outputs.changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.monitor }}-binary
        path: platform/binaries/${{ matrix.monitor }}/lambda/
        retention-days: 30

  # ===== DEPLOY INFRASTRUCTURE (Only if Changed) =====
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 45  # CloudFront distributions can take 15-20 minutes
    needs: [detect-changes, validate]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.infrastructure == 'true' || needs.detect-changes.outputs.force_infrastructure == 'true')
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Check if Binary Distribution exists
      id: check-binary-dist
      run: |
        if aws cloudformation describe-stacks --stack-name watchy-binary-distribution --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Binary distribution stack exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "üì¶ Binary distribution stack needs to be created"
        fi

    - name: Deploy Binary Distribution Infrastructure
      if: steps.check-binary-dist.outputs.exists == 'false' || needs.detect-changes.outputs.infrastructure == 'true'
      timeout-minutes: 30  # CloudFront distributions can take 15-20 minutes
      run: |
        echo "üöÄ Deploying binary distribution infrastructure..."
        echo "‚è∞ This may take up to 20 minutes for CloudFront distribution creation..."

        # Set certificate parameter based on availability
        if [ -n "${{ secrets.SSL_CERTIFICATE_ARN }}" ]; then
          CERT_PARAM="CertificateArn=${{ secrets.SSL_CERTIFICATE_ARN }}"
          echo "‚úÖ Using SSL certificate for custom domain"
        else
          CERT_PARAM="CertificateArn="
          echo "‚ö†Ô∏è  No SSL certificate provided - deploying without custom domain"
        fi

        # Deploy with extended timeout and better error handling
        set -e  # Exit on any error

        echo "üìã Starting CloudFormation deployment..."

        # Get hosted zone ID for watchy.cloud if it exists
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
          --query 'HostedZones[?contains(Name, `watchy.cloud`)].Id' \
          --output text | sed 's|/hostedzone/||' || echo "")

        if [ -n "$HOSTED_ZONE_ID" ]; then
          ZONE_PARAM="HostedZoneId=$HOSTED_ZONE_ID"
          echo "‚úÖ Found hosted zone: $HOSTED_ZONE_ID - DNS record will be created"
        else
          ZONE_PARAM="HostedZoneId="
          echo "‚ö†Ô∏è  No hosted zone found - DNS record will not be created"
        fi

        aws cloudformation deploy \
          --template-file platform/infrastructure/binary-distribution.yaml \
          --stack-name watchy-binary-distribution \
          --parameter-overrides \
            DomainName=releases.watchy.cloud \
            ${CERT_PARAM} \
            ${ZONE_PARAM} \
            Environment=prod \
          --capabilities CAPABILITY_NAMED_IAM \
          --region ${{ env.AWS_REGION }} \
          --no-fail-on-empty-changeset

        echo "‚úÖ Binary distribution infrastructure deployment completed!"

    - name: Deploy Main Platform Infrastructure
      timeout-minutes: 15  # Platform infrastructure is typically faster than CloudFront
      run: |
        echo "üöÄ Deploying main platform infrastructure..."

        set -e  # Exit on any error

        # Get the template resources bucket name from the binary distribution stack
        TEMPLATE_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name watchy-binary-distribution \
          --query 'Stacks[0].Outputs[?OutputKey==`TemplateResourcesBucket`].OutputValue' \
          --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

        if [ -n "$TEMPLATE_BUCKET" ]; then
          TEMPLATE_BASE_URL="https://${TEMPLATE_BUCKET}.s3.amazonaws.com/customer-templates/templates"
          echo "‚úÖ Using template bucket: $TEMPLATE_BUCKET"
        else
          TEMPLATE_BASE_URL="https://watchy-resources-prod.s3.amazonaws.com/customer-templates/templates"
          echo "‚ö†Ô∏è  Using default template URL"
        fi

        aws cloudformation deploy \
          --template-file platform/watchy-platform.yaml \
          --stack-name watchy-platform \
          --parameter-overrides \
            NotificationEmail=contact@watchy.cloud \
            BinaryDistributionUrl=https://releases.watchy.cloud \
            TemplateBaseUrl="${TEMPLATE_BASE_URL}" \
            Environment=prod \
          --capabilities CAPABILITY_NAMED_IAM \
          --region ${{ env.AWS_REGION }} \
          --no-fail-on-empty-changeset

        echo "‚úÖ Main platform infrastructure deployment completed!"

  # ===== DEPLOY BINARIES (Only if Built Successfully) =====
  deploy-binaries:
    name: Deploy Binaries to S3
    runs-on: ubuntu-latest
    needs: [detect-changes, build-binaries]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.build-binaries.result == 'success') &&
      (needs.detect-changes.outputs.binaries == 'true' || needs.detect-changes.outputs.infrastructure == 'true' || needs.detect-changes.outputs.force_infrastructure == 'true')

    steps:
    - name: Binary deployment status
      run: |
        echo "üöÄ Binary deployment conditions met:"
        echo "   - Build result: ${{ needs.build-binaries.result }}"
        echo "   - Binaries changed: ${{ needs.detect-changes.outputs.binaries }}"
        echo "   - Infrastructure changed: ${{ needs.detect-changes.outputs.infrastructure }}"
        echo "   - Force infrastructure: ${{ needs.detect-changes.outputs.force_infrastructure }}"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Download binary artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
      continue-on-error: true

    - name: Debug artifacts
      run: |
        echo "üîç Debugging artifact download..."
        echo "Current directory: $(pwd)"
        echo "Artifacts directory contents:"
        ls -la artifacts/ || echo "No artifacts directory found"

        for monitor in slack-monitor; do
          if [ -d "artifacts/${monitor}-binary" ]; then
            echo "‚úÖ Found artifacts for ${monitor}:"
            ls -la "artifacts/${monitor}-binary/"
          else
            echo "‚ùå No artifacts found for ${monitor}"
          fi
        done

    - name: Upload binaries to S3
      run: |
        # Get bucket name from CloudFormation stack
        BUCKET_NAME=$(aws cloudformation describe-stacks \
          --stack-name watchy-binary-distribution \
          --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
          --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

        if [ -z "$BUCKET_NAME" ] || [ "$BUCKET_NAME" = "None" ]; then
          echo "‚ö†Ô∏è  Could not get S3 bucket name from CloudFormation stack 'watchy-binary-distribution'"
          echo "This might be expected if the infrastructure hasn't been deployed yet."
          echo "Skipping binary upload..."
          exit 0
        fi

        echo "üì¶ Uploading binaries to bucket: $BUCKET_NAME"

        # Set version for this build
        VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}
        UPLOAD_COUNT=0

        # Get CloudFront distribution ID for cache invalidation (once, reuse for all monitors)
        DISTRIBUTION_ID=$(aws cloudfront list-distributions \
          --query "DistributionList.Items[?contains(Aliases.Items, 'releases.watchy.cloud')].Id | [0]" \
          --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

        if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && [ "$DISTRIBUTION_ID" != "null" ]; then
          echo "üåê Found CloudFront distribution: $DISTRIBUTION_ID"
          echo "üîÑ Will invalidate cache for all updated binaries"
        else
          echo "‚ö†Ô∏è  CloudFront distribution not found, cache invalidation will be skipped"
        fi

        # Upload each monitor's artifacts
        upload_success=true
        for monitor in slack-monitor; do
          if [ -d "artifacts/${monitor}-binary" ] && [ -f "artifacts/${monitor}-binary/watchy-${monitor}" ]; then
            echo "üì§ Uploading ${monitor} binaries..."

            # Upload versioned binary
            if aws s3 cp "artifacts/${monitor}-binary/watchy-${monitor}" \
               "s3://${BUCKET_NAME}/binaries/${monitor}/watchy-${monitor}-${VERSION}" \
               --region ${{ env.AWS_REGION }}; then
              echo "‚úÖ Uploaded versioned binary for ${monitor}"
            else
              echo "‚ùå Failed to upload versioned binary for ${monitor}"
              upload_success=false
              continue
            fi

            # Upload latest symlink
            if aws s3 cp "artifacts/${monitor}-binary/watchy-${monitor}" \
               "s3://${BUCKET_NAME}/binaries/${monitor}/watchy-${monitor}-latest" \
               --region ${{ env.AWS_REGION }}; then
              echo "‚úÖ Uploaded latest binary for ${monitor}"
            else
              echo "‚ùå Failed to upload latest binary for ${monitor}"
              upload_success=false
              continue
            fi

            echo "‚úÖ Successfully uploaded all artifacts for ${monitor}"

            # Calculate SHA256 checksum for integrity verification
            BINARY_SHA256=$(sha256sum "artifacts/${monitor}-binary/watchy-${monitor}" | cut -d' ' -f1)
            BINARY_SIZE=$(stat -c%s "artifacts/${monitor}-binary/watchy-${monitor}" 2>/dev/null || stat -f%z "artifacts/${monitor}-binary/watchy-${monitor}")

            # Create and upload metadata with SHA256 checksum
            cat > "${monitor}-metadata.json" << EOF
        {
          "version": "${VERSION}",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "gitCommit": "${GITHUB_SHA}",
          "buildNumber": "${GITHUB_RUN_NUMBER}",
          "downloadUrl": "https://releases.watchy.cloud/binaries/${monitor}/watchy-${monitor}-${VERSION}",
          "latestUrl": "https://releases.watchy.cloud/binaries/${monitor}/watchy-${monitor}-latest",
          "sha256": "${BINARY_SHA256}",
          "binarySize": ${BINARY_SIZE},
          "target_platform": "linux-x86_64",
          "lambda_compatible": true,
          "binary_type": "nuitka"
        }
        EOF

            echo "üîí Binary SHA256: ${BINARY_SHA256}"
            echo "üìè Binary Size: ${BINARY_SIZE} bytes"

            if aws s3 cp "${monitor}-metadata.json" \
              "s3://${BUCKET_NAME}/binaries/${monitor}/metadata.json" \
              --content-type "application/json" \
              --region ${{ env.AWS_REGION }}; then
              echo "‚úÖ Uploaded metadata for ${monitor}"

              # Invalidate CloudFront cache for this monitor
              if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && [ "$DISTRIBUTION_ID" != "null" ]; then
                echo "üîÑ Invalidating CloudFront cache for ${monitor}..."

                # Create invalidation for latest binary, versioned binary, and metadata
                INVALIDATION_PATHS="/binaries/${monitor}/watchy-${monitor}-latest,/binaries/${monitor}/watchy-${monitor}-${VERSION},/binaries/${monitor}/metadata.json"

                if INVALIDATION_ID=$(aws cloudfront create-invalidation \
                  --distribution-id "$DISTRIBUTION_ID" \
                  --paths "$INVALIDATION_PATHS" \
                  --query 'Invalidation.Id' \
                  --output text \
                  --region ${{ env.AWS_REGION }} 2>/dev/null); then
                  echo "‚úÖ CloudFront cache invalidation created for ${monitor} (ID: $INVALIDATION_ID)"
                else
                  echo "‚ö†Ô∏è  Failed to invalidate CloudFront cache for ${monitor} (non-critical)"
                fi
              fi
            else
              echo "‚ùå Failed to upload metadata for ${monitor}"
              upload_success=false
            fi
          else
            echo "‚ö†Ô∏è  No artifacts found for ${monitor}, skipping upload"
          fi
        done

        if [ "$upload_success" = "false" ]; then
          echo "‚ùå Some uploads failed"
          exit 1
        else
          echo "üéâ All binary uploads completed successfully!"

          # Final summary for cache invalidation
          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ] && [ "$DISTRIBUTION_ID" != "null" ]; then
            echo "üîÑ CloudFront cache invalidations have been initiated for all updated binaries"
            echo "   Distribution: $DISTRIBUTION_ID"
            echo "   Note: Cache invalidation may take 5-15 minutes to complete"
          else
            echo "‚ö†Ô∏è  No CloudFront cache invalidations were performed (distribution not found)"
          fi
        fi

  # ===== DEPLOY PLATFORM (When Platform or Website Changes) =====
  deploy-platform:
    name: Deploy Platform Files
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: |
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (needs.detect-changes.outputs.platform == 'true' || needs.detect-changes.outputs.website == 'true' || github.event_name == 'workflow_dispatch')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy website
      if: needs.detect-changes.outputs.website == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "üåê Deploying website..."
        echo "üìÅ Website files to deploy:"
        ls -la website/

        # Deploy website files to S3 bucket
        aws s3 sync website/ s3://watchy.cloud/ \
          --delete \
          --cache-control "max-age=3600" \
          --region ${{ env.AWS_REGION }}

        echo "‚úÖ Website files deployed to S3"

        # Find CloudFront distribution for watchy.cloud
        echo "üîç Finding CloudFront distribution for watchy.cloud..."
        WEBSITE_DISTRIBUTION_ID=$(aws cloudfront list-distributions \
          --query "DistributionList.Items[?contains(Aliases.Items, 'watchy.cloud')].Id | [0]" \
          --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

        if [ -n "$WEBSITE_DISTRIBUTION_ID" ] && [ "$WEBSITE_DISTRIBUTION_ID" != "None" ] && [ "$WEBSITE_DISTRIBUTION_ID" != "null" ]; then
          echo "‚úÖ Found CloudFront distribution: $WEBSITE_DISTRIBUTION_ID"

          # Create cache invalidation for website files
          echo "üîÑ Invalidating CloudFront cache for website..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "$WEBSITE_DISTRIBUTION_ID" \
            --paths "/index.html" "/*" \
            --query 'Invalidation.Id' \
            --output text \
            --region ${{ env.AWS_REGION }})

          if [ -n "$INVALIDATION_ID" ]; then
            echo "‚úÖ Created CloudFront invalidation: $INVALIDATION_ID"
            echo "‚è≥ Waiting for cache invalidation to complete..."

            # Wait for invalidation to complete (with timeout)
            timeout 300 aws cloudfront wait invalidation-completed \
              --distribution-id "$WEBSITE_DISTRIBUTION_ID" \
              --id "$INVALIDATION_ID" \
              --region ${{ env.AWS_REGION }} || echo "‚ö†Ô∏è Invalidation timeout, continuing..."

            echo "‚úÖ Website cache invalidation completed"
            echo "üåê Website updated at: https://watchy.cloud"
          else
            echo "‚ùå Failed to create CloudFront invalidation"
          fi
        else
          echo "‚ö†Ô∏è CloudFront distribution for watchy.cloud not found, skipping cache invalidation"
        fi

    - name: Deploy platform files
      if: needs.detect-changes.outputs.platform == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        VERSION=$(date -u +%Y.%m.%d.%H%M%S)-${GITHUB_SHA:0:7}

        echo "üì§ Deploying platform files v${VERSION}..."

        # Get the template resources bucket name from CloudFormation
        TEMPLATE_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name watchy-binary-distribution \
          --query 'Stacks[0].Outputs[?OutputKey==`TemplateResourcesBucket`].OutputValue' \
          --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

        if [ -n "$TEMPLATE_BUCKET" ]; then
          echo "‚úÖ Deploying to template bucket: $TEMPLATE_BUCKET"

          # Deploy platform files to template bucket
          aws s3 sync platform/ s3://${TEMPLATE_BUCKET}/platform/ \
            --delete \
            --cache-control "max-age=86400" \
            --region ${{ env.AWS_REGION }}

          # Deploy customer templates to template bucket
          aws s3 sync customer-templates/ s3://${TEMPLATE_BUCKET}/customer-templates/ \
            --delete \
            --cache-control "max-age=86400" \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Platform files deployed to releases.watchy.cloud"

          # Invalidate CloudFront cache for updated templates and platform files
          RESOURCES_DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${TEMPLATE_BUCKET}.s3.amazonaws.com\`].Id | [0]" \
            --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "$RESOURCES_DISTRIBUTION_ID" ] && [ "$RESOURCES_DISTRIBUTION_ID" != "None" ] && [ "$RESOURCES_DISTRIBUTION_ID" != "null" ]; then
            echo "üîÑ Invalidating CloudFront cache for templates and platform files..."
            if aws cloudfront create-invalidation \
              --distribution-id "$RESOURCES_DISTRIBUTION_ID" \
              --paths "/customer-templates/*" "/platform/*" \
              --region ${{ env.AWS_REGION }} \
              --output text >/dev/null 2>&1; then
              echo "‚úÖ CloudFront cache invalidated for templates and platform files"
            else
              echo "‚ö†Ô∏è  Failed to invalidate CloudFront cache (non-critical)"
            fi
          else
            echo "‚ö†Ô∏è  CloudFront distribution not found for template resources, skipping cache invalidation"
          fi
        else
          echo "‚ö†Ô∏è  Template bucket not found, skipping template deployment"
        fi

  # ===== PUBLISH TO PUBLIC GITHUB =====
  publish-to-github:
    name: Publish to Public GitHub Repository
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: github.ref == 'refs/heads/main' && (needs.detect-changes.outputs.platform == 'true' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout public repository
      uses: actions/checkout@v4
      with:
        repository: refaktr-io/watchy
        token: ${{ secrets.PUBLIC_REPO_TOKEN }}
        path: public-repo

    - name: Copy CloudFormation template
      run: |
        echo "üìã Copying CloudFormation template to public repository..."
        cp platform/watchy-platform.yaml public-repo/watchy-platform.yaml
        echo "‚úÖ Template copied"

    - name: Copy README
      run: |
        echo "üìÑ Copying README to public repository..."
        cp platform/README.md public-repo/README.md
        echo "‚úÖ README copied"

    - name: Copy Architecture Documentation
      run: |
        echo "üìê Copying architecture documentation to public repository..."
        mkdir -p public-repo/docs
        cp docs/ARCHITECTURE.md public-repo/docs/ARCHITECTURE.md
        echo "‚úÖ Architecture documentation copied"

    - name: Commit and push to public repository
      run: |
        cd public-repo
        
        # Configure git
        git config user.name "refaktr-automation"
        git config user.email "refaktr-automation@users.noreply.github.com"
        
        # Check if there are changes
        if git diff --quiet && git diff --cached --quiet; then
          echo "‚ÑπÔ∏è  No changes to publish"
          exit 0
        fi
        
        # Stage changes
        git add watchy-platform.yaml README.md docs/
        
        # Commit with version information
        VERSION=$(date -u +%Y.%m.%d.%H%M%S)
        COMMIT_SHA="${GITHUB_SHA:0:7}"
        git commit -m "Update Watchy platform v${VERSION}

        - CloudFormation template updated
        - README documentation updated
        - Source commit: ${GITHUB_SHA}
        
        Published from: https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
        
        # Push to main branch
        git push origin main
        
        echo "‚úÖ Published to public repository"
        echo "üåê View at: https://github.com/refaktr-io/watchy"

  # ===== TEST STAGE =====
  test-deployment:
    name: Test Deployment
    runs-on: ubuntu-latest
    needs: [deploy-binaries, deploy-platform]
    if: always() && (needs.deploy-platform.result == 'success' || needs.deploy-binaries.result == 'success')

    steps:
    - name: Test deployment endpoints
      run: |
        echo "üß™ Testing deployment..."

        # Test website
        if curl -f https://watchy.cloud/; then
          echo "‚úÖ Website is accessible"
        else
          echo "‚ùå Website is not accessible"
          exit 1
        fi

        # Test platform files
        if curl -f https://releases.watchy.cloud/platform/watchy-platform.yaml; then
          echo "‚úÖ Platform files are accessible on releases.watchy.cloud"
        else
          echo "‚ö†Ô∏è  Platform files not accessible on releases.watchy.cloud"
        fi

        # Test binary distribution
        if curl -f https://releases.watchy.cloud/binaries/slack-monitor/metadata.json; then
          echo "‚úÖ Binary distribution is working"
        else
          echo "‚ö†Ô∏è  Binary distribution not accessible yet (CloudFront may still be deploying)"
        fi

        echo "‚úÖ Deployment test completed"

  # ===== NOTIFICATION =====
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test-deployment, detect-changes]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
    - name: Deployment Summary
      run: |
        echo "## üöÄ Deployment Summary"
        echo "### Changes Detected:"
        echo "- Infrastructure: ${{ needs.detect-changes.outputs.infrastructure }}"
        echo "- Binaries: ${{ needs.detect-changes.outputs.binaries }}"
        echo "- Platform: ${{ needs.detect-changes.outputs.platform }}"
        echo "- Website: ${{ needs.detect-changes.outputs.website }}"
        echo "- Force Infrastructure: ${{ needs.detect-changes.outputs.force_infrastructure }}"

        if [ "${{ needs.test-deployment.result }}" = "success" ]; then
          echo "### ‚úÖ Deployment Successful!"
          echo "üåê Platform: https://watchy.cloud/"
          echo "üì¶ Binaries: https://releases.watchy.cloud/"
          echo "üìã Platform API: https://watchy.cloud/platform/"
        else
          echo "### ‚ùå Deployment Issues"
          echo "Check the workflow logs for details"
        fi

        echo ""
        echo "## üîí Security Summary"
        echo "### Enabled Features:"
        echo "- ‚úÖ Dependency vulnerability scanning (Safety)"
        echo "- ‚úÖ Python security analysis (Bandit)"
        echo "- ‚úÖ Secret pattern detection"
        echo "- ‚úÖ CloudFormation security checks"
        echo "- ‚úÖ File permission auditing"
        echo "- ‚úÖ Dependabot dependency updates"
        echo ""
        echo "### Security Recommendations:"
        echo "- Review Dependabot PRs promptly"
        echo "- Monitor the Security tab for dependency alerts"
        echo "- Use GitHub secrets for sensitive values"
        echo "- Follow principle of least privilege in IAM policies"
