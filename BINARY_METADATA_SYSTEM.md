# Binary Metadata System Documentation

## Overview
The Watchy platform uses a dual-metadata system to provide binary information and integrity verification for compiled monitoring applications.

## Metadata Files Structure

### 1. Template Files (Static)
Located in: `platform/binaries/{monitor}/lambda/watchy-{monitor}.json`

**Purpose**: Static templates with build configuration and platform information
**Example**: `platform/binaries/slack-monitor/lambda/watchy-slack-monitor.json`

```json
{
  "version": "1.0.0",
  "build_time": "2025-08-30T20:24:00Z",
  "download_url": "https://releases.watchy.cloud/slack-monitor/watchy-slack-monitor",
  "sha256": "calculated_during_build_and_available_in_metadata_endpoint",
  "compression": "none",
  "binary_type": "nuitka",
  "target_platform": "linux-x86_64",
  "lambda_compatible": true,
  "metadata": {
    "saas_app": "Slack",
    "monitor_type": "status",
    "python_version": "3.11",
    "compiler": "nuitka",
    "compiler_version": "2.7.13"
  }
}
```

### 2. Live Metadata (Generated)
**Location**: `s3://bucket/binaries/{monitor}/metadata.json`
**Endpoint**: `https://releases.watchy.cloud/binaries/{monitor}/metadata.json`

**Purpose**: Real-time build information with actual SHA256 checksums
**Generated by**: GitHub Actions during CI/CD deployment

```json
{
  "version": "2025.08.30.202400-a1b2c3d",
  "buildTime": "2025-08-30T20:24:00Z",
  "gitCommit": "a1b2c3d4e5f6789012345678901234567890abcd",
  "buildNumber": "123",
  "downloadUrl": "https://releases.watchy.cloud/binaries/slack-monitor/watchy-slack-monitor-2025.08.30.202400-a1b2c3d",
  "latestUrl": "https://releases.watchy.cloud/binaries/slack-monitor/watchy-slack-monitor-latest",
  "sha256": "abc123def456789012345678901234567890abcdef1234567890123456789012",
  "binarySize": 45678901,
  "target_platform": "linux-x86_64",
  "lambda_compatible": true,
  "binary_type": "nuitka"
}
```

## SHA256 Checksum Lifecycle

### 1. During Build (`build.sh`)
```bash
# Calculate SHA256 of compiled binary
BINARY_HASH=$(shasum -a 256 "${DIST_DIR}/watchy-slack-monitor-${VERSION}" | cut -d' ' -f1)

# Create build-time metadata with real SHA256
cat > ${DIST_DIR}/watchy-slack-monitor-info.json << EOF
{
  "sha256": "${BINARY_HASH}",
  ...
}
EOF
```

### 2. During GitHub Actions Deployment
```bash
# Calculate SHA256 checksum for integrity verification
BINARY_SHA256=$(sha256sum "artifacts/${monitor}-binary/watchy-${monitor}" | cut -d' ' -f1)

# Include in live metadata uploaded to S3
cat > "${monitor}-metadata.json" << EOF
{
  "sha256": "${BINARY_SHA256}",
  "binarySize": ${BINARY_SIZE},
  ...
}
EOF
```

### 3. Runtime Verification
Applications can verify binary integrity by:
1. Downloading the binary
2. Fetching metadata from: `https://releases.watchy.cloud/binaries/{monitor}/metadata.json`
3. Calculating SHA256 of downloaded binary
4. Comparing with `metadata.sha256` field

## Usage Examples

### Get Current Binary Metadata
```bash
curl https://releases.watchy.cloud/binaries/slack-monitor/metadata.json
```

### Download and Verify Binary
```bash
#!/bin/bash
MONITOR="slack-monitor"

# Download metadata
METADATA=$(curl -s https://releases.watchy.cloud/binaries/${MONITOR}/metadata.json)
EXPECTED_SHA256=$(echo $METADATA | jq -r '.sha256')
DOWNLOAD_URL=$(echo $METADATA | jq -r '.latestUrl')

# Download binary
curl -o watchy-${MONITOR} "${DOWNLOAD_URL}"

# Verify integrity
ACTUAL_SHA256=$(sha256sum watchy-${MONITOR} | cut -d' ' -f1)
if [ "$EXPECTED_SHA256" = "$ACTUAL_SHA256" ]; then
  echo "✅ Binary integrity verified"
else
  echo "❌ Binary integrity check failed!"
  exit 1
fi
```

## Security Benefits

1. **Integrity Verification**: SHA256 checksums ensure downloaded binaries haven't been tampered with
2. **Version Tracking**: Git commit hashes link binaries to exact source code
3. **Build Provenance**: Build numbers and timestamps provide audit trail
4. **Automated Updates**: Live metadata automatically reflects latest builds

## File Locations

- **Template Files**: `platform/binaries/{monitor}/lambda/watchy-{monitor}.json`
- **Build Metadata**: `platform/binaries/{monitor}/dist/watchy-{monitor}-info.json` (build-time)
- **Live Metadata**: `s3://bucket/binaries/{monitor}/metadata.json` (runtime)
- **Public Endpoint**: `https://releases.watchy.cloud/binaries/{monitor}/metadata.json`

## GitHub Actions Integration

The CI/CD pipeline automatically:
1. ✅ Builds binaries with Nuitka
2. ✅ Calculates SHA256 checksums
3. ✅ Uploads binaries to S3
4. ✅ Generates and uploads live metadata
5. ✅ Provides integrity verification logs

This system ensures that all binary deployments have verifiable integrity and complete provenance tracking.
